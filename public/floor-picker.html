<!DOCTYPE html>
<html>
<head>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #1a1a2e; font-family: monospace; color: #fff; }
  .bar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    background: rgba(26,26,46,0.95); padding: 8px 16px;
    display: flex; align-items: center; gap: 12px;
    border-bottom: 2px solid #c5943a;
  }
  .bar h3 { color: #c5943a; font-size: 14px; }
  .pos { background: #000; padding: 4px 12px; border-radius: 4px; font-size: 14px; color: #0f0; min-width: 160px; }
  .btn { padding: 5px 12px; border: 1px solid #c5943a; background: transparent; color: #c5943a; cursor: pointer; border-radius: 4px; font-size: 11px; }
  .btn:hover { background: #c5943a; color: #fff; }
  .btn.red { border-color: #e74c3c; color: #e74c3c; }
  .btn.red:hover { background: #e74c3c; color: #fff; }
  .step { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; }
  .step-left { background: #e74c3c; color: #fff; }
  .step-right { background: #3498db; color: #fff; }

  .wrap { margin-top: 44px; display: flex; }
  .img-area { flex: 1; position: relative; cursor: crosshair; overflow: auto; }
  .img-area img { display: block; max-height: calc(100vh - 50px); width: auto; }
  .hline { position: absolute; left: 0; right: 0; height: 1px; background: rgba(197,148,58,0.5); pointer-events: none; z-index: 10; }
  .vline { position: absolute; top: 0; bottom: 0; width: 1px; background: rgba(197,148,58,0.5); pointer-events: none; z-index: 10; }
  .dot { position: absolute; width: 8px; height: 8px; border-radius: 50%; transform: translate(-50%,-50%); pointer-events: none; z-index: 20; }
  .dot-left { background: #e74c3c; }
  .dot-right { background: #3498db; }
  .fline-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 15; }
  .flabel { position: absolute; transform: translate(10px,-50%); background: rgba(0,0,0,0.85); color: #2ecc71; padding: 2px 8px; font-size: 10px; border-radius: 3px; pointer-events: none; z-index: 16; white-space: nowrap; }

  .side {
    width: 320px; background: rgba(26,26,46,0.95); border-left: 2px solid #c5943a;
    padding: 12px; overflow-y: auto; max-height: calc(100vh - 44px); position: fixed; right: 0; top: 44px; bottom: 0;
  }
  .side h4 { color: #c5943a; margin: 8px 0 6px; font-size: 12px; }
  .row { display: flex; gap: 6px; align-items: center; margin-bottom: 6px; }
  .row label { font-size: 10px; color: #aaa; min-width: 50px; }
  .row input { background: #333; border: 1px solid #555; color: #fff; padding: 3px 6px; border-radius: 3px; font-size: 11px; flex: 1; }
  .item { display: flex; justify-content: space-between; padding: 3px 6px; border-bottom: 1px solid #333; font-size: 10px; }
  .item:hover { background: rgba(197,148,58,0.1); }
  .del { color: #e74c3c; cursor: pointer; padding: 0 4px; }
  .out { margin-top: 8px; background: #000; padding: 8px; border-radius: 4px; font-size: 10px; color: #0f0; white-space: pre-wrap; max-height: 300px; overflow-y: auto; user-select: all; }
  .hint { font-size: 9px; color: #888; margin-top: 4px; }
</style>
</head>
<body>

<div class="bar">
  <h3>Floor Picker</h3>
  <div class="pos" id="pos">Move mouse...</div>
  <span class="step step-left" id="stepLabel">Click LEFT point</span>
  <span style="color:#c5943a;font-size:11px" id="cnt">Floors: 0</span>
  <button class="btn" onclick="copyOut()">Copy JSON (C)</button>
  <button class="btn red" onclick="undo()">Undo (Z)</button>
  <button class="btn red" onclick="clearAll()">Clear</button>
</div>

<div class="wrap">
  <div class="img-area" id="area">
    <img id="img" src="/images/building-elevation.png" />
    <div class="hline" id="hline"></div>
    <div class="vline" id="vline"></div>
    <svg class="fline-svg" id="linesSvg"></svg>
  </div>
</div>

<div class="side">
  <h4>Settings</h4>
  <div class="row">
    <label>Floor #:</label>
    <input type="number" id="fnum" value="42" min="1" max="82" />
  </div>
  <p class="hint">
    1st click = <span style="color:#e74c3c">LEFT point</span> of floor<br>
    2nd click = <span style="color:#3498db">RIGHT point</span> of floor<br>
    Auto decrements after each floor done.
  </p>

  <h4>Recorded Floors (<span id="total">0</span>)</h4>
  <div id="list"></div>

  <h4>JSON Output</h4>
  <div class="out" id="out">// Click on building image...</div>
</div>

<script>
const area = document.getElementById('area');
const img = document.getElementById('img');
const hline = document.getElementById('hline');
const vline = document.getElementById('vline');
const posEl = document.getElementById('pos');
const stepLabel = document.getElementById('stepLabel');
const linesSvg = document.getElementById('linesSvg');

let floors = [];
let leftPoint = null; // waiting for right click

area.addEventListener('mousemove', (e) => {
  const r = img.getBoundingClientRect();
  const y = ((e.clientY - r.top) / r.height * 100).toFixed(1);
  const x = ((e.clientX - r.left) / r.width * 100).toFixed(1);
  posEl.textContent = 'x: ' + x + '%  y: ' + y + '%';
  hline.style.top = (e.clientY - r.top) + 'px';
  vline.style.left = (e.clientX - r.left) + 'px';
});

area.addEventListener('click', (e) => {
  const r = img.getBoundingClientRect();
  const xPct = parseFloat(((e.clientX - r.left) / r.width * 100).toFixed(1));
  const yPct = parseFloat(((e.clientY - r.top) / r.height * 100).toFixed(1));
  const px = e.clientX - r.left;
  const py = e.clientY - r.top;

  if (!leftPoint) {
    // First click — LEFT point
    leftPoint = { x: xPct, y: yPct, px, py };

    // Draw red dot
    const dot = document.createElement('div');
    dot.className = 'dot dot-left';
    dot.style.left = px + 'px';
    dot.style.top = py + 'px';
    dot.id = 'tempDot';
    area.appendChild(dot);

    stepLabel.textContent = 'Click RIGHT point';
    stepLabel.className = 'step step-right';
  } else {
    // Second click — RIGHT point
    const num = parseInt(document.getElementById('fnum').value);

    floors.push({
      floor: num,
      x1: leftPoint.x, y1: leftPoint.y,
      x2: xPct, y2: yPct
    });

    // Draw blue dot
    const dot = document.createElement('div');
    dot.className = 'dot dot-right';
    dot.style.left = px + 'px';
    dot.style.top = py + 'px';
    area.appendChild(dot);

    // Draw line between left and right
    drawLine(leftPoint.px, leftPoint.py, px, py, num);

    // Remove temp dot id
    const tempDot = document.getElementById('tempDot');
    if (tempDot) tempDot.removeAttribute('id');

    // Reset
    leftPoint = null;
    document.getElementById('fnum').value = Math.max(1, num - 1);
    stepLabel.textContent = 'Click LEFT point';
    stepLabel.className = 'step step-left';

    render();
  }
});

function drawLine(x1, y1, x2, y2, floorNum) {
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.setAttribute('x1', x1);
  line.setAttribute('y1', y1);
  line.setAttribute('x2', x2);
  line.setAttribute('y2', y2);
  line.setAttribute('stroke', 'rgba(46,204,113,0.7)');
  line.setAttribute('stroke-width', '2');
  linesSvg.appendChild(line);

  // Label at midpoint
  const midX = (x1 + x2) / 2;
  const midY = (y1 + y2) / 2;
  const lbl = document.createElement('div');
  lbl.className = 'flabel';
  lbl.style.left = midX + 'px';
  lbl.style.top = midY + 'px';
  lbl.textContent = 'F' + floorNum;
  area.appendChild(lbl);
}

function render() {
  document.getElementById('cnt').textContent = 'Floors: ' + floors.length;
  document.getElementById('total').textContent = floors.length;

  document.getElementById('list').innerHTML = floors.map((f, i) =>
    '<div class="item"><span>F' + f.floor + ': L(' + f.x1 + ',' + f.y1 + ') R(' + f.x2 + ',' + f.y2 + ')</span><span class="del" onclick="del(' + i + ')">x</span></div>'
  ).join('');

  const sorted = [...floors].sort((a, b) => b.floor - a.floor);
  let json = 'const floorPositions = {\n';
  sorted.forEach(f => {
    json += '  ' + f.floor + ': { x1: ' + f.x1 + ', y1: ' + f.y1 + ', x2: ' + f.x2 + ', y2: ' + f.y2 + ' },\n';
  });
  json += '};\n';
  document.getElementById('out').textContent = json;
}

function del(i) { floors.splice(i, 1); render(); }

function undo() {
  if (leftPoint) {
    // Cancel current left point
    leftPoint = null;
    const tempDot = document.getElementById('tempDot');
    if (tempDot) tempDot.remove();
    stepLabel.textContent = 'Click LEFT point';
    stepLabel.className = 'step step-left';
  } else {
    floors.pop();
    render();
  }
}

function clearAll() {
  floors = [];
  leftPoint = null;
  area.querySelectorAll('.dot,.flabel').forEach(el => el.remove());
  linesSvg.innerHTML = '';
  stepLabel.textContent = 'Click LEFT point';
  stepLabel.className = 'step step-left';
  render();
}

function copyOut() {
  navigator.clipboard.writeText(document.getElementById('out').textContent);
  alert('Copied!');
}

document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT') return;
  if (e.key === 'z') undo();
  if (e.key === 'c') copyOut();
});
</script>
</body>
</html>
